<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Hello Brieux — Lead Transformer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --radius: 16px;
      --ring: 0 0 0 1px rgba(17, 24, 39, .06);
    }
    /* Air-like background */
    body{
      background:
        radial-gradient(1200px 800px at 70% -10%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(900px 600px at -10% 20%, rgba(99,102,241,.15), transparent 55%),
        #fafafa;
    }
    .container-card{
      background: #fff;
      border-radius: var(--radius);
      box-shadow:
        0 10px 30px rgba(17,24,39,.06),
        var(--ring);
    }
    .field{
      appearance: none;
      width: 100%;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: .72rem .9rem;
      transition: box-shadow .2s ease, border-color .2s ease, transform .02s ease;
    }
    .field:focus{
      outline: none;
      border-color: #93c5fd;
      box-shadow: 0 0 0 4px rgba(59,130,246,.15);
    }
    .btn{
      border-radius: 12px;
      padding: .78rem 1rem;
      font-weight: 600;
      transition: transform .04s ease, box-shadow .25s ease, background .2s ease, color .2s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(180deg, #111827 0%, #0b1220 100%);
      color: #fff;
      box-shadow:
        0 12px 24px rgba(17,24,39,.15),
        inset 0 1px 0 rgba(255,255,255,.12);
    }
    .btn-primary:hover{ filter: brightness(1.04); }
    .btn-ghost{
      background: #fff;
      border: 1px solid #e5e7eb;
      color: #111827;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body class="text-slate-900 antialiased">
  <main class="max-w-4xl mx-auto px-6 py-10">
    <!-- Hero -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">Hello Brieux</h1>
      <p class="text-slate-600 mt-3 max-w-2xl">
        Déposez l’export (souvent <span class="mono">UTF-16 + tabs</span>), choisissez le
        <span class="mono">broker</span> et la date — recevez un CSV normalisé (séparateur <span class="mono">|</span>, <span class="mono">UTF-8</span>).
      </p>
    </header>

    <!-- Card -->
    <section class="container-card p-6 md:p-7 mb-6">
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium mb-1">Fichier d’entrée (CSV)</label>
          <input id="fileInput" type="file" accept=".csv,text/csv" class="field">
          <p class="text-slate-500 text-xs mt-1">Export formulaire (souvent UTF-16 + tabulations).</p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">
            Broker <span class="text-slate-400">(champ <span class="mono">partner_name</span>)</span>
          </label>
          <input id="broker" type="text" class="field" placeholder="PAID_LEAD" value="PAID_LEAD">
          <p class="text-slate-500 text-xs mt-1">Appliqué à toutes les lignes.</p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Date <span class="text-slate-400">(YYYY-MM-DD)</span></label>
          <input id="date" type="text" class="field" placeholder="auto : aujourd’hui (Europe/Paris)">
          <p class="text-slate-500 text-xs mt-1">Utilisée pour <span class="mono">creation_date</span> et <span class="mono">last_interaction_date</span>.</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">brand_code</label>
            <input id="brand" type="text" class="field" value="PR">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">country_code</label>
            <input id="country" type="text" class="field" value="FR">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">language_code</label>
            <input id="lang" type="text" class="field" value="FR">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">collected_mode</label>
            <input id="collected" type="text" class="field" value="CRG">
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-3">
        <button id="btnConvert" class="btn btn-primary">Convertir & Télécharger</button>
        <button id="btnSample" class="btn btn-ghost">CSV exemple</button>
      </div>

      <p id="status" class="text-slate-600 text-sm mt-4"></p>
    </section>

    <footer class="text-xs text-slate-500 text-center py-6">
      Réalisé par 24tiy pour un usage interne au sein de DPR.
    </footer>
  </main>

  <script>
    // ===== Utils
    const tzParis = 'Europe/Paris';
    const todayParisISO = () =>
      new Intl.DateTimeFormat('en-CA', { timeZone: tzParis }).format(new Date()); // YYYY-MM-DD

    // Prendre prénom/nom tels quels (trim seulement)
    function passName(str){ return String(str ?? '').trim(); }

    function parseFRPhone(v){
      if (v == null) return '';
      let s = String(v);
      s = s.replace(/[^0-9+]/g, '');
      if (s.startsWith('+33')) s = '0' + s.slice(3);
      s = s.replace(/\D/g, '');
      if (s.startsWith('0')) s = s.slice(1);
      if (s.length >= 9) s = s.slice(-9);
      return s;
    }

    function detectDelimiter(text){
      const first = text.split(/\r?\n/)[0] || '';
      const c = {
        '\t': (first.match(/\t/g) || []).length,
        '|':  (first.match(/\|/g) || []).length,
        ';':  (first.match(/;/g) || []).length,
        ',':  (first.match(/,/g) || []).length
      };
      return Object.entries(c).sort((a,b)=>b[1]-a[1])[0][0] || '\t';
    }

    function parseCSV(text, delim){
      const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.length>0);
      if (!lines.length) return { header: [], rows: [] };
      const header = lines[0].split(delim).map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const cols = line.split(delim);
        const obj = {};
        header.forEach((h,i)=> obj[h] = (cols[i] ?? '').trim());
        return obj;
      });
      return { header, rows };
    }

    function toPipeCSV(rows, header){
      const esc = v => (v == null ? '' : String(v)).replace(/\r?\n/g, ' ').replace(/\|/g, '\\|');
      const head = header.join('|');
      const body = rows.map(r => header.map(h => esc(r[h])).join('|')).join('\n');
      return head + '\n' + body + '\n';
    }

    function download(filename, text){
      const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    function status(msg){ document.getElementById('status').textContent = msg; }

    // Exemple CSV (UTF-16LE + tabs) pour test visuel
    document.getElementById('btnSample').addEventListener('click', () => {
      const sample = [
        ['id','created_time','ad_id','ad_name','adset_id','adset_name','campaign_id','campaign_name','form_id','form_name','is_organic','platform','prénom','nom_de_famille','email','phone_number','lead_status'],
        ['l:123','2025-10-15T19:44:39+02:00','ag:123','ad','as:1','set','c:1','cmp','f:1','form','False','fb','EVELYNE','BERTRAND','eveelynebertrand75@hotmail.fr','p:+33663697077','complete'],
        ['l:124','2025-10-15T19:07:32+02:00','ag:123','ad','as:1','set','c:1','cmp','f:1','form','False','fb','Stéphanie','Lavier','st.lavier@laposte.net','p:+33760090328','complete'],
        ['l:125','2025-10-15T19:07:32+02:00','ag:123','ad','as:1','set','c:1','cmp','f:1','form','False','fb','Valerie','Marty','valerie.marty8@orange.fr','p:+33685459498','complete'],
      ].map(r=>r.join('\t')).join('\n');
      const bom = new Uint8Array([0xFF,0xFE]); // UTF-16LE BOM
      const encoder = new TextEncoder('utf-16le');
      const data = new Blob([bom, encoder.encode(sample)], { type: 'text/csv' });
      const url = URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url; a.download = 'input_exemple_utf16_tab.csv';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    });

    // Convert
    document.getElementById('btnConvert').addEventListener('click', async () => {
      status('');
      const f = document.getElementById('fileInput').files[0];
      if (!f){ status('Choisis un fichier CSV.'); return; }

      const broker    = document.getElementById('broker').value.trim()   || 'PAID_LEAD';
      const brand     = document.getElementById('brand').value.trim()    || 'PR';
      const country   = document.getElementById('country').value.trim()  || 'FR';
      const lang      = document.getElementById('lang').value.trim()     || 'FR';
      const collected = document.getElementById('collected').value.trim()|| 'CRG';
      const dateIn    = document.getElementById('date').value.trim()     || todayParisISO();

      try{
        // Lecture (gestion UTF-16)
        let text = await f.text();
        if (/\x00/.test(text)){
          const buf = await f.arrayBuffer();
          text = new TextDecoder('utf-16le').decode(buf);
          if (!text.trim()) text = new TextDecoder('utf-16be').decode(buf);
        }

        const delim = detectDelimiter(text);
        const { header, rows } = parseCSV(text, delim);
        if (!rows.length){ status('Fichier vide ou non reconnu.'); return; }

        const need = ['prénom','nom_de_famille','email','phone_number'];
        const have = new Set(header.map(h => h.toLowerCase()));
        const lowerMap = Object.fromEntries(header.map(h => [h.toLowerCase(), h]));
        const missing = need.filter(c => !have.has(c));
        if (missing.length){
          status('Colonnes manquantes : ' + missing.join(', ') + '.');
          return;
        }

        const outHeader = [
          'brand_code','country_code','partner_name','title','first_name','last_name','birthdate','email',
          'zip_code','mobil_phone','fix_phone','language_code','collected_mode','creation_date',
          'internal_consent','creation_date_internal_consent','partner_consent','creation_date_partner_consent',
          'last_interaction_date'
        ];

        const outRows = rows.map(r => {
          const first = passName(r[ lowerMap['prénom'] ]);
          const last  = passName(r[ lowerMap['nom_de_famille'] ]);
          const email = (r[ lowerMap['email'] ] ?? '').trim();
          const phone = parseFRPhone(r[ lowerMap['phone_number'] ]);

          // FR rule: 6/7 → mobile, otherwise fix
          let mobil = '', fix = '';
          if (phone){
            if (phone.startsWith('6') || phone.startsWith('7')) mobil = phone;
            else fix = phone;
          }

          return {
            brand_code: brand,
            country_code: country,
            partner_name: broker,
            title: '',
            first_name: first,
            last_name: last,
            birthdate: '',
            email: email,
            zip_code: '',
            mobil_phone: mobil,
            fix_phone: fix,
            language_code: lang,
            collected_mode: collected,
            creation_date: dateIn,
            internal_consent: 'True',
            creation_date_internal_consent: '',
            partner_consent: 'False',
            creation_date_partner_consent: '',
            last_interaction_date: dateIn
          };
        });

        const outCSV = toPipeCSV(outRows, outHeader);

        // Nom de fichier strict : INIT_LEADS_PRFR_YYYYMMDD000003.csv
        const ymd = dateIn.replace(/-/g, '');
        const filename = `INIT_LEADS_PRFR_${ymd}000003.csv`;

        download(filename, outCSV);
        status(`OK — ${filename} généré.`);
      }catch(e){
        console.error(e);
        status('Erreur : ' + (e.message || e));
      }
    });

    // Placeholder = date du jour
    document.getElementById('date').placeholder = todayParisISO() + ' (par défaut)';
  </script>
</body>
</html>
