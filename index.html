<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Hello Brieux — Lead Transformer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --radius: 18px; --glass-bg: rgba(255,255,255,0.14); --glass-bd: rgba(255,255,255,0.35); }
    /* Background */
    body {
      min-height: 100dvh;
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(66,133,244,.25), transparent 60%),
        radial-gradient(1000px 700px at 110% 0%, rgba(15,157,88,.20), transparent 55%),
        linear-gradient(180deg, #0f172a 0%, #111827 100%);
      color: #e5e7eb;
    }
    /* Glass card */
    .glass {
      background: var(--glass-bg);
      border: 1px solid var(--glass-bd);
      border-radius: var(--radius);
      backdrop-filter: blur(16px) saturate(120%);
      -webkit-backdrop-filter: blur(16px) saturate(120%);
      box-shadow:
        0 10px 30px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.08);
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .btn {
      border-radius: 14px;
      padding: .7rem 1rem;
      font-weight: 600;
      transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn-primary {
      color: #0b0f19; background: #a7f3d0;
      box-shadow: 0 8px 20px rgba(167,243,208,.25), inset 0 1px 0 rgba(255,255,255,.6);
    }
    .btn-primary:hover { transform: translateY(-1px); }
    .btn-ghost {
      color: #e5e7eb; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12);
    }
    input[type="text"], input[type="file"] {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.18);
      color: #e5e7eb;
      border-radius: 12px;
      padding: .6rem .8rem;
      width: 100%;
    }
    input::placeholder { color: #94a3b8; }
    .hint { color: #9ca3af; font-size: .78rem; }
    .title { color: #f3f4f6; }
    .subtle { color: #cbd5e1; }
    footer { color: #94a3b8; }
  </style>
</head>
<body>
  <main class="max-w-3xl mx-auto px-6 py-10">
    <header class="mb-8">
      <h1 class="title text-3xl font-semibold tracking-tight">Hello Brieux</h1>
      <p class="subtle mt-1 text-sm">Convertit un CSV brut (UTF-16 + tabulations) vers le format cible (séparateur <span class="mono">|</span>, UTF-8).</p>
    </header>

    <section class="glass p-6 mb-6">
      <div class="grid md:grid-cols-2 gap-5">
        <div>
          <label class="block text-sm font-medium mb-1">Fichier d’entrée (CSV)</label>
          <input id="fileInput" type="file" accept=".csv,text/csv">
          <p class="hint mt-1">Export formulaire (souvent UTF-16 + tabulations).</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Broker (<span class="mono">partner_name</span>)</label>
          <input id="broker" type="text" placeholder="PAID_LEAD" value="PAID_LEAD">
          <p class="hint mt-1">Appliqué à toutes les lignes.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Date (YYYY-MM-DD)</label>
          <input id="date" type="text" placeholder="auto : aujourd’hui (Europe/Paris)">
          <p class="hint mt-1">Utilisée pour <span class="mono">creation_date</span> et <span class="mono">last_interaction_date</span>.</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">brand_code</label>
            <input id="brand" type="text" value="PR">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">country_code</label>
            <input id="country" type="text" value="FR">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">language_code</label>
            <input id="lang" type="text" value="FR">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">collected_mode</label>
            <input id="collected" type="text" value="CRG">
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-3">
        <button id="btnConvert" class="btn btn-primary">Convertir & Télécharger</button>
        <button id="btnSample" class="btn btn-ghost">CSV exemple</button>
      </div>
      <p id="status" class="hint mt-3"></p>
    </section>

    <footer class="mt-10 text-xs text-center">
      Réalisé par 24tiy pour un usage interne au sein de DPR.
    </footer>
  </main>

  <script>
    // ===== Utils
    const tzParis = 'Europe/Paris';
    const todayParisISO = () =>
      new Intl.DateTimeFormat('en-CA', { timeZone: tzParis }).format(new Date()); // YYYY-MM-DD

    // Берём имя/фамилию КАК ЕСТЬ (только trim)
    function passthroughName(str) {
      return String(str ?? '').trim();
    }

    function parseFRPhone(v) {
      if (v == null) return '';
      let s = String(v);
      s = s.replace(/[^0-9+]/g, '');
      if (s.startsWith('+33')) s = '0' + s.slice(3);
      s = s.replace(/\D/g, '');
      if (s.startsWith('0')) s = s.slice(1);
      if (s.length >= 9) s = s.slice(-9);
      return s;
    }

    function detectDelimiter(text) {
      const firstLine = text.split(/\r?\n/)[0] || '';
      const counts = { '\t': (firstLine.match(/\t/g) || []).length,
                       '|': (firstLine.match(/\|/g) || []).length,
                       ';': (firstLine.match(/;/g) || []).length,
                       ',': (firstLine.match(/,/g) || []).length };
      return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || '\t';
    }

    function parseCSV(text, delim) {
      const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.length>0);
      if (!lines.length) return { header: [], rows: [] };
      const header = lines[0].split(delim).map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const cols = line.split(delim);
        const obj = {};
        header.forEach((h,i)=> obj[h] = (cols[i] ?? '').trim());
        return obj;
      });
      return { header, rows };
    }

    function toPipeCSV(rows, header) {
      const esc = v => (v == null ? '' : String(v)).replace(/\r?\n/g, ' ').replace(/\|/g, '\\|');
      const head = header.join('|');
      const body = rows.map(r => header.map(h => esc(r[h])).join('|')).join('\n');
      return head + '\n' + body + '\n';
    }

    function download(filename, text) {
      const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    function status(msg) {
      const el = document.getElementById('status');
      el.textContent = msg;
    }

    // Пример входного файла (UTF-16LE + табы)
    document.getElementById('btnSample').addEventListener('click', () => {
      const sample = [
        ['id','created_time','ad_id','ad_name','adset_id','adset_name','campaign_id','campaign_name','form_id','form_name','is_organic','platform','prénom','nom_de_famille','email','phone_number','lead_status'],
        ['l:123','2025-10-15T19:44:39+02:00','ag:123','ad','as:1','set','c:1','cmp','f:1','form','False','fb','EVELYNE','BERTRAND','eveelynebertrand75@hotmail.fr','p:+33663697077','complete'],
        ['l:124','2025-10-15T19:07:32+02:00','ag:123','ad','as:1','set','c:1','cmp','f:1','form','False','fb','Stéphanie','Lavier','st.lavier@laposte.net','p:+33760090328','complete'],
        ['l:125','2025-10-15T19:07:32+02:00','ag:123','ad','as:1','set','c:1','cmp','f:1','form','False','fb','Valerie','Marty','valerie.marty8@orange.fr','p:+33685459498','complete'],
      ].map(r=>r.join('\t')).join('\n');
      const bom = new Uint8Array([0xFF,0xFE]); // UTF-16LE BOM
      const encoder = new TextEncoder('utf-16le');
      const data = new Blob([bom, encoder.encode(sample)], { type: 'text/csv' });
      const url = URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url; a.download = 'input_exemple_utf16_tab.csv';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    });

    // Конвертация
    document.getElementById('btnConvert').addEventListener('click', async () => {
      status('');
      const f = document.getElementById('fileInput').files[0];
      if (!f) { status('Choisis un fichier CSV.'); return; }

      const broker   = document.getElementById('broker').value.trim() || 'PAID_LEAD';
      const brand    = document.getElementById('brand').value.trim()  || 'PR';
      const country  = document.getElementById('country').value.trim()|| 'FR';
      const lang     = document.getElementById('lang').value.trim()   || 'FR';
      const collected= document.getElementById('collected').value.trim() || 'CRG';
      const dateIn   = document.getElementById('date').value.trim() || todayParisISO();

      try {
        // чтение (детект UTF-16)
        let text = await f.text();
        if (/\x00/.test(text)) {
          const buf = await f.arrayBuffer();
          text = new TextDecoder('utf-16le').decode(buf);
          if (!text.trim()) text = new TextDecoder('utf-16be').decode(buf);
        }

        const delim = detectDelimiter(text);
        const { header, rows } = parseCSV(text, delim);
        if (!rows.length) { status('Fichier vide ou non reconnu.'); return; }

        const need = ['prénom','nom_de_famille','email','phone_number'];
        const have = new Set(header.map(h=>h.toLowerCase()));
        const lowerMap = Object.fromEntries(header.map(h=>[h.toLowerCase(), h]));
        const missing = need.filter(c => !have.has(c));
        if (missing.length) {
          status('Colonnes manquantes : ' + missing.join(', ') + '.');
          return;
        }

        const outHeader = [
          'brand_code','country_code','partner_name','title','first_name','last_name','birthdate','email',
          'zip_code','mobil_phone','fix_phone','language_code','collected_mode','creation_date',
          'internal_consent','creation_date_internal_consent','partner_consent','creation_date_partner_consent',
          'last_interaction_date'
        ];

        const outRows = rows.map(r => {
          const first = passthroughName(r[ lowerMap['prénom'] ]);
          const last  = passthroughName(r[ lowerMap['nom_de_famille'] ]);
          const email = (r[ lowerMap['email'] ] ?? '').trim();
          const phone = parseFRPhone(r[ lowerMap['phone_number'] ]);

          // FR-правило: 6/7 → mobile, иначе фикс
          let mobil = '', fix = '';
          if (phone) {
            if (phone.startsWith('6') || phone.startsWith('7')) mobil = phone;
            else fix = phone;
          }

          return {
            brand_code: brand,
            country_code: country,
            partner_name: broker,
            title: '',
            first_name: first,
            last_name: last,
            birthdate: '',
            email: email,
            zip_code: '',
            mobil_phone: mobil,
            fix_phone: fix,
            language_code: lang,
            collected_mode: collected,
            creation_date: dateIn,
            internal_consent: 'True',
            creation_date_internal_consent: '',
            partner_consent: 'False',
            creation_date_partner_consent: '',
            last_interaction_date: dateIn
          };
        });

        const outCSV = toPipeCSV(outRows, outHeader);

        // Имя файла строго по шаблону: INIT_LEADS_PRFR_YYYYMMDD000003.csv
        const ymd = dateIn.replace(/-/g, ''); // YYYYMMDD
        const filename = `INIT_LEADS_PRFR_${ymd}000003.csv`;

        download(filename, outCSV);
        status(`OK — ${filename} généré.`);
      } catch (e) {
        console.error(e);
        status('Erreur: ' + (e.message || e));
      }
    });

    // проставляем плейсхолдер сегодняшней датой
    document.getElementById('date').placeholder = todayParisISO() + ' (par défaut)';
  </script>
</body>
</html>
